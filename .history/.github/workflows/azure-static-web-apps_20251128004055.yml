name: Blue/Green Deployment - Azure Static Web Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  # Step 1: Deploy to Staging Environment (Green)
  deploy_to_staging:
    if: github.event_name == 'push' || github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest
    name: üü¢ Deploy to Staging (Green)
    environment:
      name: staging
      url: ${{ steps.deploy_staging.outputs.static_web_app_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for Staging
        run: npm run build:staging
        env:
          VITE_API_BASE_URL: ${{ secrets.STAGING_API_BASE_URL }}
          VITE_APP_ENV: staging
          VITE_APP_NAME: ${{ secrets.VITE_APP_NAME }} (Staging)
          VITE_APP_VERSION: ${{ secrets.VITE_APP_VERSION }}

      - name: Deploy to Azure Static Web Apps (Staging Slot)
        id: deploy_staging
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_STAGING }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          api_location: ""
          output_location: "dist"
          skip_app_build: true
          deployment_environment: staging

      - name: üì¢ Staging Deployment Complete
        run: |
          echo "üü¢ Staging Environment URL: ${{ steps.deploy_staging.outputs.static_web_app_url }}"
          echo "‚úÖ Please test the staging environment before promoting to production"
          echo "üìù To promote to production, manually trigger the workflow and select 'production'"

  # Step 2: Deploy to Production Environment (Blue) - Requires Manual Approval
  deploy_to_production:
    if: github.event.inputs.environment == 'production'
    runs-on: ubuntu-latest
    name: üîµ Deploy to Production (Blue)
    environment:
      name: production
      url: ${{ steps.deploy_production.outputs.static_web_app_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for Production
        run: npm run build
        env:
          VITE_API_BASE_URL: ${{ secrets.PRODUCTION_API_BASE_URL }}
          VITE_APP_ENV: production
          VITE_APP_NAME: ${{ secrets.VITE_APP_NAME }}
          VITE_APP_VERSION: ${{ secrets.VITE_APP_VERSION }}

      - name: Deploy to Azure Static Web Apps (Production)
        id: deploy_production
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_PRODUCTION }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          api_location: ""
          output_location: "dist"
          skip_app_build: true
          deployment_environment: production

      - name: üì¢ Production Deployment Complete
        run: |
          echo "üîµ Production Environment URL: ${{ steps.deploy_production.outputs.static_web_app_url }}"
          echo "‚úÖ Production deployment successful!"
          echo "üîÑ Previous version is still available for quick rollback if needed"

