name: Blue/Green Deployment - Azure Static Web Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  # Step 1: Deploy to Staging Environment (Green)
  deploy_to_staging:
    if: github.event_name == 'push' || github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest
    name: üü¢ Deploy to Staging (Green)
    environment:
      name: staging
      url: ${{ steps.deploy_staging.outputs.static_web_app_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for Staging
        run: npm run build:staging
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || 'http://localhost:8000/api' }}
          VITE_APP_ENV: staging
          VITE_APP_NAME: "LensArt (Staging)"
          VITE_APP_VERSION: "1.0.0"

      - name: Deploy to Azure Static Web Apps (Staging Slot)
        id: deploy_staging
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets. npm run build:staging
  shell: /usr/bin/bash -e {0}
  env:
    VITE_API_BASE_URL: ***
    VITE_APP_ENV: staging
    VITE_APP_NAME: LensArt (Staging)
    VITE_APP_VERSION: 1.0.0
  
> client@0.0.0 build:staging
> vite build --mode staging
vite v5.4.10 building for staging...
transforming...
/fonts/SF-Pro-Display-Regular.otf referenced in /fonts/SF-Pro-Display-Regular.otf didn't resolve at build time, it will remain unchanged to be resolved at runtime
/fonts/SF-Pro-Display-Medium.otf referenced in /fonts/SF-Pro-Display-Medium.otf didn't resolve at build time, it will remain unchanged to be resolved at runtime
/fonts/SF-Pro-Display-Bold.otf referenced in /fonts/SF-Pro-Display-Bold.otf didn't resolve at build time, it will remain unchanged to be resolved at runtime
‚úì 345 modules transformed.
x Build failed in 3.69s
error during build:
Could not resolve "../../../../../utils/api" from "src/components/Admin/Manage_Categories/Materials/CreateMaterial.jsx"
file: /home/runner/work/client_lensart/client_lensart/src/components/Admin/Manage_Categories/Materials/CreateMaterial.jsx
    at getRollupError (file:///home/runner/work/client_lensart/client_lensart/node_modules/rollup/dist/es/shared/parseAst.js:396:41)
    at error (file:///home/runner/work/client_lensart/client_lensart/node_modules/rollup/dist/es/shared/parseAst.js:392:42)
    at ModuleLoader.handleInvalidResolvedId (file:///home/runner/work/client_lensart/client_lensart/node_modules/rollup/dist/es/shared/node-entry.js:20083:24)
    at file:///home/runner/work/client_lensart/client_lensart/node_modules/rollup/dist/es/shared/node-entry.js:20043:26
Error: Process completed with exit code 1. }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          api_location: ""
          output_location: "dist"
          skip_app_build: true

      - name: üì¢ Staging Deployment Complete
        run: |
          echo "üü¢ Staging Environment URL: ${{ steps.deploy_staging.outputs.static_web_app_url }}"
          echo "‚úÖ Please test the staging environment before promoting to production"
          echo "üìù To promote to production, manually trigger the workflow and select 'production'"

  # Step 2: Deploy to Production Environment (Blue) - Requires Manual Approval
  deploy_to_production:
    if: github.event.inputs.environment == 'production'
    runs-on: ubuntu-latest
    name: üîµ Deploy to Production (Blue)
    environment:
      name: production
      url: ${{ steps.deploy_production.outputs.static_web_app_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for Production
        run: npm run build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || 'http://localhost:8000/api' }}
          VITE_APP_ENV: production
          VITE_APP_NAME: "LensArt"
          VITE_APP_VERSION: "1.0.0"

      - name: Deploy to Azure Static Web Apps (Production)
        id: deploy_production
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN_LEMON_TREE_07B9C0900 }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "/"
          api_location: ""
          output_location: "dist"
          skip_app_build: true

      - name: üì¢ Production Deployment Complete
        run: |
          echo "üîµ Production Environment URL: ${{ steps.deploy_production.outputs.static_web_app_url }}"
          echo "‚úÖ Production deployment successful!"
          echo "üîÑ Previous version is still available for quick rollback if needed"

